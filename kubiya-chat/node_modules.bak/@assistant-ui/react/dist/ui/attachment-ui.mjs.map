{"version":3,"sources":["../../src/ui/attachment-ui.tsx"],"sourcesContent":["\"use client\";\n\nimport {\n  forwardRef,\n  PropsWithChildren,\n  useEffect,\n  useState,\n  type FC,\n} from \"react\";\nimport { CircleXIcon, FileIcon } from \"lucide-react\";\nimport { withDefaults } from \"./utils/withDefaults\";\nimport { useThreadConfig } from \"./thread-config\";\nimport { TooltipIconButton } from \"./base/tooltip-icon-button\";\nimport { AttachmentPrimitive } from \"../primitives\";\nimport { useAttachment } from \"../context/react/AttachmentContext\";\nimport {\n  AvatarImage,\n  AvatarRoot,\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"./base\";\nimport { Dialog, DialogTrigger, DialogContent } from \"./base/dialog\";\nimport { AvatarFallback } from \"@radix-ui/react-avatar\";\nimport { useShallow } from \"zustand/shallow\";\nimport { DialogTitle } from \"@radix-ui/react-dialog\";\n\nconst AttachmentRoot = withDefaults(AttachmentPrimitive.Root, {\n  className: \"aui-attachment-root\",\n});\n\nconst AttachmentContent = withDefaults(\"div\", {\n  className: \"aui-attachment-content\",\n});\n\nAttachmentRoot.displayName = \"AttachmentRoot\";\n\nconst useFileSrc = (file: File | undefined) => {\n  const [src, setSrc] = useState<string | undefined>(undefined);\n\n  useEffect(() => {\n    if (!file) {\n      setSrc(undefined);\n      return;\n    }\n\n    const objectUrl = URL.createObjectURL(file);\n    setSrc(objectUrl);\n\n    return () => {\n      URL.revokeObjectURL(objectUrl);\n    };\n  }, [file]);\n\n  return src;\n};\n\nconst useAttachmentSrc = () => {\n  const { file, src } = useAttachment(\n    useShallow((a): { file?: File; src?: string } => {\n      if (a.type !== \"image\") return {};\n      if (a.file) return { file: a.file };\n      const src = a.content?.filter((c) => c.type === \"image\")[0]?.image;\n      if (!src) return {};\n      return { src };\n    }),\n  );\n\n  return useFileSrc(file) ?? src;\n};\n\ntype AttachmentPreviewProps = {\n  src: string;\n};\n\nconst AttachmentPreview: FC<AttachmentPreviewProps> = ({ src }) => {\n  const [isLoaded, setIsLoaded] = useState(false);\n\n  return (\n    // eslint-disable-next-line @next/next/no-img-element\n    <img\n      src={src}\n      style={{\n        width: \"auto\",\n        height: \"auto\",\n        maxWidth: \"75dvh\",\n        maxHeight: \"75dvh\",\n        display: isLoaded ? \"block\" : \"none\",\n        overflow: \"clip\",\n      }}\n      onLoad={() => setIsLoaded(true)}\n      alt=\"Image Preview\"\n    />\n  );\n};\n\nconst AttachmentPreviewDialog: FC<PropsWithChildren> = ({ children }) => {\n  const src = useAttachmentSrc();\n\n  if (!src) return children;\n\n  return (\n    <Dialog>\n      <DialogTrigger className=\"aui-attachment-preview-trigger\" asChild>\n        {children}\n      </DialogTrigger>\n      <DialogContent>\n        <DialogTitle className=\"aui-sr-only\">\n          Image Attachment Preview\n        </DialogTitle>\n        <AttachmentPreview src={src} />\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nconst AttachmentThumb: FC = () => {\n  const isImage = useAttachment((a) => a.type === \"image\");\n  const src = useAttachmentSrc();\n  return (\n    <AvatarRoot className=\"aui-attachment-thumb\">\n      <AvatarFallback delayMs={isImage ? 200 : 0}>\n        <FileIcon />\n      </AvatarFallback>\n      <AvatarImage src={src}></AvatarImage>\n    </AvatarRoot>\n  );\n};\n\nconst AttachmentUI: FC = () => {\n  const canRemove = useAttachment((a) => a.source !== \"message\");\n  const typeLabel = useAttachment((a) => {\n    const type = a.type;\n    switch (type) {\n      case \"image\":\n        return \"Image\";\n      case \"document\":\n        return \"Document\";\n      case \"file\":\n        return \"File\";\n      default:\n        const _exhaustiveCheck: never = type;\n        throw new Error(`Unknown attachment type: ${_exhaustiveCheck}`);\n    }\n  });\n  return (\n    <Tooltip>\n      <AttachmentRoot>\n        <AttachmentPreviewDialog>\n          <TooltipTrigger asChild>\n            <AttachmentContent>\n              <AttachmentThumb />\n              <div className=\"aui-attachment-text\">\n                <p className=\"aui-attachment-name\">\n                  <AttachmentPrimitive.Name />\n                </p>\n                <p className=\"aui-attachment-type\">{typeLabel}</p>\n              </div>\n            </AttachmentContent>\n          </TooltipTrigger>\n        </AttachmentPreviewDialog>\n        {canRemove && <AttachmentRemove />}\n      </AttachmentRoot>\n      <TooltipContent side=\"top\">\n        <AttachmentPrimitive.Name />\n      </TooltipContent>\n    </Tooltip>\n  );\n};\n\nAttachmentUI.displayName = \"Attachment\";\n\nnamespace AttachmentRemove {\n  export type Element = HTMLButtonElement;\n  export type Props = Partial<TooltipIconButton.Props>;\n}\n\nconst AttachmentRemove = forwardRef<\n  AttachmentRemove.Element,\n  AttachmentRemove.Props\n>((props, ref) => {\n  const {\n    strings: {\n      composer: { removeAttachment: { tooltip = \"Remove file\" } = {} } = {},\n    } = {},\n  } = useThreadConfig();\n\n  return (\n    <AttachmentPrimitive.Remove asChild>\n      <TooltipIconButton\n        tooltip={tooltip}\n        className=\"aui-attachment-remove\"\n        side=\"top\"\n        {...props}\n        ref={ref}\n      >\n        {props.children ?? <CircleXIcon />}\n      </TooltipIconButton>\n    </AttachmentPrimitive.Remove>\n  );\n});\n\nAttachmentRemove.displayName = \"AttachmentRemove\";\n\nconst exports = {\n  Root: AttachmentRoot,\n  Remove: AttachmentRemove,\n};\n\nexport default Object.assign(AttachmentUI, exports) as typeof AttachmentUI &\n  typeof exports;\n"],"mappings":"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","names":["src"]}